var Placeholder=new Class({edited:false,input:false,placeholder:false,Implements:[Options,Events],options:{onlyOnce:true},initialize:function(a,b,c){this.setOptions(c);this.input=$(a);this.placeholder=b;this.input.addEvent("change",function(){this.edited=true}.bind(this));this.input.addEvent("focus",this.setOnFocus.bind(this));this.input.addEvent("blur",this.setOnBlur.bind(this))},setOnFocus:function(){if(this.options.onlyOnce===true&&this.edited===true){this.removeEvents();return false}this.input.get("value")==
this.placeholder&&this.input.set("value","")},setOnBlur:function(){if(this.options.onlyOnce===true&&this.edited===true){this.removeEvents();return false}this.input.get("value")==""&&this.input.set("value",this.placeholder)},removeEvents:function(){this.input.removeEvent("focus",this.setOnFocus);this.input.removeEvent("blur",this.setOnBlur)}}),BookmarkActiveLink=new Class({Implements:[Options,Events],options:{onFormSuccess:function(){},onFormError:function(){},onClose:function(){},loadPlaceholder:new Element("div.ajax_bar_div"),
containerId:"main_container",stickyOpts:{allowMultiple:false,closeOnClickOut:false,closeOnEsc:true,destroyOnClose:true,showNow:true},loadRequestOpts:{method:"get",noCache:true},sendRequestOpts:{method:"post",noCache:true}},currentLink:false,currentStickyWin:false,currentForm:false,initialize:function(a,b){this.setOptions(b);$(this.options.containerId).addEvent("click:relay("+a+")",this.loadFormFromLink.bind(this))},loadFormFromLink:function(a,b){a.preventDefault();this.currentLink=$(b);this.createWin();
this.currentStickyWin.update();this.currentStickyWin.show()},createWin:function(){var a,b;a=this.currentLink.get("href");b=this.options.stickyOpts;b.url=a;b.requestOptions=this.options.loadRequestOpts;b.requestOptions.onComplete=function(){setTimeout(function(){this.currentStickyWin.position();this.bindForm()}.bind(this),30)}.bind(this);this.currentStickyWin=new StickyWin.Ajax(b);this.currentStickyWin.addEvent("close",function(){this.fireEvent("close")}.bind(this))},bindForm:function(){var a;a=this.currentStickyWin.element.getElement("form");
a=$(a);this.currentForm=new Form.Request(a,{resetForm:false,requestOptions:this.options.sendRequestOpts});a.addEvent("submit",this.sendForm.bind(this));this.currentForm.request.addEvent("success",this.getFormResult.bind(this))},sendForm:function(a){a.preventDefault();this.currentForm.send()},getFormResult:function(a,b,c){this.currentStickyWin.setContent(c);this.currentStickyWin.position();c.toLowerCase().indexOf("<form")===-1?this.fireEvent("formSuccess"):this.fireEvent("formError")}}),SiteNavigation=
new Class({Implements:[Options,Events],options:{searchChunk:"q",sortChunk:"s",tagsChunk:"tags",pageChunk:"page",tagsSelector:".tag",selectedTagClass:"ui-selected",selectedTagPrefix:".tag_",timeout:300,hashTimeout:50,containerId:"main_container",requestOpts:{method:"get",noCache:true,chain:"cancel"},onReload:function(){}},currentTags:[],lastLoadTimeout:false,loadOpts:{},loadUrl:false,navigation:{},searchInput:false,initialize:function(a,b,c){this.loadUrl=a;this.searchInput=$(b);this.options.onReload=
this.onReload;this.setOptions(c);this.loadOpts=this.options.requestOpts;this.loadOpts.url=this.loadUrl;this.loadOpts.update=this.options.containerId;this.bindEvens();this.checkHash()},lastHash:false,checkHash:function(){var a;a=window.location.hash;if(this.lastHash===false||this.lastHash!=a){this.lastHash=a;this.fireEvent("reload")}setTimeout(function(){this.checkHash()}.bind(this),this.options.hashTimeout)},bindEvens:function(){this.searchInput.addEvent("keyup",function(){this.setHashSearchValue()}.bind(this));
$(window).addEvent("click:relay("+this.options.tagsSelector+")",this.addTag.bind(this))},addTag:function(a){var b,c;a.preventDefault();b=a.target.get("rel");if(b===null)return false;a=this.getURI();this.checkCurrentTags();if(this.currentTags===null||this.currentTags.length==0){a.setData(this.options.tagsChunk,b);this.setHash(a);this.currentTags=[b];return false}if(this.currentTags.indexOf(b)!==-1)this.currentTags=Array.filter(this.currentTags,function(d){return d!==b}.bind(this));else this.currentTags.push(b);
c=this.options.tagsChunk+"="+this.currentTags.join("&"+this.options.tagsChunk+"=");a.setData(this.options.tagsChunk);this.setHash(a,c)},checkCurrentTags:function(){uri=this.getURI();this.currentTags=uri.getData(this.options.tagsChunk)||null;if(typeOf(this.currentTags)==="string")this.currentTags=[this.currentTags]},mapTags:function(){$$(this.options.tagsSelector).removeClass(this.options.selectedTagClass);if(this.currentTags===null)return false;this.currentTags.each(function(a){$$(this.options.selectedTagPrefix+
a).addClass(this.options.selectedTagClass)}.bind(this))},getURI:function(){return new URI(this.loadUrl+"?"+window.location.hash.replace(/^#/,""))},getSearchValue:function(){return this.searchInput.get("value")},setHashSearchValue:function(){var a;a=this.getURI();a.setData(this.options.searchChunk,this.getSearchValue());this.setHash(a)},setHash:function(a,b){var c;c=a.get("query");if(b)c=c.trim().length>0?c+"&"+b:b;window.location.hash=c},onReload:function(){this.lastLoadTimeout!==false&&clearTimeout(this.lastLoadTimeout);
this.loadOpts.url=this.getURI().toString();this.loadOpts.onComplete=function(){setTimeout(function(){this.checkCurrentTags();this.mapTags()}.bind(this),20)}.bind(this);this.lastLoadTimeout=setTimeout(function(){(new Request.HTML(this.loadOpts)).send()}.bind(this),this.options.timeout)}});
