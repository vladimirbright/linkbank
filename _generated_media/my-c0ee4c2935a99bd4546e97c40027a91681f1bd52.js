var Placeholder=new Class({edited:false,input:false,placeholder:false,Implements:[Options,Events],options:{onlyOnce:true},initialize:function(a,b,c){this.setOptions(c);this.input=$(a);this.placeholder=b;this.input.addEvent("change",function(){this.edited=true}.bind(this));this.input.addEvent("focus",this.setOnFocus.bind(this));this.input.addEvent("blur",this.setOnBlur.bind(this))},setOnFocus:function(){if(this.options.onlyOnce===true&&this.edited===true){this.removeEvents();return false}this.input.get("value")==
this.placeholder&&this.input.set("value","")},setOnBlur:function(){if(this.options.onlyOnce===true&&this.edited===true){this.removeEvents();return false}this.input.get("value")==""&&this.input.set("value",this.placeholder)},removeEvents:function(){this.input.removeEvent("focus",this.setOnFocus);this.input.removeEvent("blur",this.setOnBlur)}}),BookmarkActiveLink=new Class({Implements:[Options,Events],options:{onFormSuccess:function(){},onFormError:function(){},onClose:function(){},loadPlaceholder:new Element("div.ajax_bar_div"),
containerId:"main_container",stickyOpts:{allowMultiple:false,closeOnClickOut:false,closeOnEsc:true,destroyOnClose:true,showNow:true},loadRequestOpts:{method:"get",noCache:true},sendRequestOpts:{method:"post",noCache:true}},currentLink:false,currentStickyWin:false,currentForm:false,initialize:function(a,b){this.setOptions(b);$(this.options.containerId).addEvent("click:relay("+a+")",this.loadFormFromLink.bind(this))},loadFormFromLink:function(a,b){a.preventDefault();this.currentLink=$(b);this.createWin();
this.currentStickyWin.update();this.currentStickyWin.show()},createWin:function(){var a,b;a=this.currentLink.get("href");b=this.options.stickyOpts;b.url=a;b.requestOptions=this.options.loadRequestOpts;b.requestOptions.onComplete=function(){setTimeout(function(){this.currentStickyWin.position();this.bindForm()}.bind(this),30)}.bind(this);this.currentStickyWin=new StickyWin.Ajax(b);this.currentStickyWin.addEvent("close",function(){this.fireEvent("close")}.bind(this))},bindForm:function(){var a;a=this.currentStickyWin.element.getElement("form");
a=$(a);this.currentForm=new Form.Request(a,{resetForm:false,requestOptions:this.options.sendRequestOpts});a.addEvent("submit",this.sendForm.bind(this));this.currentForm.request.addEvent("success",this.getFormResult.bind(this))},sendForm:function(a){a.preventDefault();this.currentForm.send()},getFormResult:function(a,b,c){this.currentStickyWin.setContent(c);this.currentStickyWin.position();c.toLowerCase().indexOf("<form")===-1?this.fireEvent("formSuccess",this.currentStickyWin):this.fireEvent("formError",
this.currentStickyWin,this.currentForm)}}),SiteNavigation=new Class({Implements:[Options,Events],options:{searchChunk:"q",sortChunk:"s",tagsChunk:"tags",pageChunk:"page",sortedClass:"sorted",sortSelector:".sorting",pageSelector:".page",tagsSelector:".tag",selectedTagClass:"ui-selected",selectedTagPrefix:".tag_",timeout:300,hashTimeout:50,containerId:"main_container",requestOpts:{method:"get",noCache:true,chain:"cancel"},onReload:function(){},onPageReset:function(){},onHashSet:function(){}},lastLoadTimeout:false,
loadOpts:{},loadUrl:false,navigation:{},searchInput:false,initialize:function(a,b,c){this.loadUrl=a;this.searchInput=$(b);this.options.onReload=this.onReload;this.options.onPageReset=this.onPageReset;this.options.onHashSet=this.onHashSet;this.setOptions(c);this.loadOpts=this.options.requestOpts;this.loadOpts.update=this.options.containerId;this.bindEvens();this.checkHash()},lastHash:false,checkHash:function(){var a;a=window.location.hash;if(this.lastHash===false||this.lastHash!=a){this.lastHash=a;
this.fireEvent("reload")}setTimeout(function(){this.checkHash()}.bind(this),this.options.hashTimeout)},onHashSet:function(){var a,b;b="";if(this.options.searchChunk in this.navigation)b=b+this.options.searchChunk+"="+this.navigation[this.options.searchChunk];else this.navigation[this.options.searchChunk]="";if(this.options.sortChunk in this.navigation)b=b+"&"+this.options.sortChunk+"="+this.navigation[this.options.sortChunk];if(this.options.pageChunk in this.navigation)if(this.navigation[this.options.pageChunk]>
1)b=b+"&"+this.options.pageChunk+"="+this.navigation[this.options.pageChunk];else this.navigation[this.options.pageChunk]=1;if(this.options.tagsChunk in this.navigation){a=this.navigation[this.options.tagsChunk];if(Type.isArray(a)&&a.length>0)b=b+"&"+this.options.tagsChunk+"="+a.join("&"+this.options.tagsChunk+"=");else this.navigation[this.options.tagsChunk]=[]}window.location.hash=b.replace(/^&/,"")},bindEvens:function(){this.searchInput.addEvent("keyup",this.addSearch.bind(this));$(window).addEvent("click:relay("+
this.options.tagsSelector+")",this.addTag.bind(this));$(window).addEvent("click:relay("+this.options.sortSelector+")",this.addSort.bind(this));$(this.options.containerId).addEvent("click:relay("+this.options.pageSelector+")",this.addPage.bind(this))},onPageReset:function(){this.navigation[this.options.pageChunk]=1},addSearch:function(){this.fireEvent("pageReset");this.navigation[this.options.searchChunk]=this.searchInput.get("value");this.fireEvent("hashSet")},addPage:function(a){a.preventDefault();
this.navigation[this.options.pageChunk]=a.target.get("rel")||1;this.fireEvent("hashSet")},addSort:function(a){a.preventDefault();this.navigation[this.options.sortChunk]=a.target.get("rel")||"added";$$(this.options.sortSelector).removeClass(this.options.sortedClass);a.target.addClass(this.options.sortedClass);this.fireEvent("hashSet")},addTag:function(a){var b;a.preventDefault();this.fireEvent("pageReset");b=a.target.get("rel");if(b===null)return false;a=[];if(this.options.tagsChunk in this.navigation)a=
this.navigation[this.options.tagsChunk];if(a===null||a.length==0){this.navigation[this.options.tagsChunk]=[b];this.fireEvent("hashSet");return false}if(Type.isArray(a))if(a.indexOf(b)!==-1)a=Array.filter(a,function(c){return c!==b}.bind(this));else a.push(b);else a=[];this.navigation[this.options.tagsChunk]=a;this.fireEvent("hashSet")},mapTags:function(){var a;$$(this.options.tagsSelector).removeClass(this.options.selectedTagClass);a=this.navigation[this.options.tagsChunk];if(Type.isArray(a)===false||
a.length==0)return false;a.each(function(b){$$(this.options.selectedTagPrefix+b).addClass(this.options.selectedTagClass)}.bind(this))},onReload:function(){this.lastLoadTimeout!==false&&clearTimeout(this.lastLoadTimeout);this.loadOpts.url=this.loadUrl+"?"+window.location.hash.replace(/^#/,"");this.loadOpts.onComplete=function(){setTimeout(function(){this.mapTags()}.bind(this),20)}.bind(this);this.lastLoadTimeout=setTimeout(function(){(new Request.HTML(this.loadOpts)).send()}.bind(this),this.options.timeout)}});
